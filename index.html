<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>React TODO List</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="root"></div>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef, useContext, createContext } = React;
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);

    // Custom hook lưu localStorage
    function useLocalStorage(key, initialValue) {
      const [value, setValue] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initialValue;
        } catch {
          return initialValue;
        }
      });
      
      useEffect(() => {
        localStorage.setItem(key, JSON.stringify(value));
      }, [key, value]);
      
      return [value, setValue];
    }

    // Context chia sẻ dữ liệu todo
    const TodoContext = createContext();

    // Component: TodoForm
    function TodoForm() {
      const { setTodos } = useContext(TodoContext);
      const [text, setText] = useState('');
      const [error, setError] = useState('');
      const inputRef = useRef(); // useRef để focus sau khi add

      const handleSubmit = (e) => {
        e.preventDefault();
        
        // Validation
        if (text.trim() === '') {
          setError('Don\'t let blank!');
          return;
        }
        
        // Add todo
        const newItem = { 
          id: uid(), 
          text: text.trim(), 
          done: false, 
          createdAt: Date.now() 
        };
        setTodos(prev => [newItem, ...prev]);
        
        // Reset form
        setText('');
        setError('');
        inputRef.current.focus();
      };

      return (
        <form onSubmit={handleSubmit} className="todo-form">
          <input
            type="text"
            ref={inputRef}
            placeholder="Type your work..."
            value={text}
            onChange={(e) => {
              setText(e.target.value);
              if (error) setError('');
            }}
          />
          <button type="submit">Add</button>
          {error && <div style={{ color:'red', fontSize:'14px', marginTop:'5px' }}>{error}</div>}
        </form>
      );
    }

    // Component: TodoItem
    function TodoItem({ item, onToggle, onDelete, onEdit }) {
      const [editing, setEditing] = useState(false);
      const [text, setText] = useState(item.text);
      const inputRef = useRef();

      useEffect(() => {
        if (editing && inputRef.current) {
          inputRef.current.focus();
        }
      }, [editing]);

      const handleSave = () => {
        if (text.trim()) {
          onEdit(item.id, text.trim());
          setEditing(false);
        }
      };

      const handleCancel = () => {
        setText(item.text); // Reset về text cũ
        setEditing(false);
      };

      return (
        <div className="todo">
          <input 
            type="checkbox" 
            checked={item.done} 
            onChange={() => onToggle(item.id)} 
          />
          <div className="text">
            {editing ? (
              <input 
                type="text" 
                ref={inputRef} 
                value={text} 
                onChange={e => setText(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') handleSave();
                  if (e.key === 'Escape') handleCancel();
                }}
              />
            ) : (
              <span style={{ textDecoration: item.done ? 'line-through' : 'none' }}>
                {item.text}
              </span>
            )}
            <div className="timestamp">
              Created: {new Date(item.createdAt).toLocaleString()}
            </div>
          </div>
          <div className="actions">
            {editing ? (
              <>
                <button onClick={handleSave}>Save</button>
                <button onClick={handleCancel} style={{ background:'slategray' }}>
                  Cancel
                </button>
              </>
            ) : (
              <>
                <button onClick={() => setEditing(true)}>Edit</button>
                <button onClick={() => onDelete(item.id)} style={{ background:'red' }}>
                  Delete
                </button>
              </>
            )}
          </div>
        </div>
      );
    }

    // Main component
    function TodoApp() {
      const [todos, setTodos] = useLocalStorage('todos_v2', []);
      const [filter, setFilter] = useState('all');

      // useCallback
      const toggleDone = useCallback((id) => {
        setTodos(prev => prev.map(t => 
          t.id === id ? { ...t, done: !t.done } : t
        ));
      }, [setTodos]);

      const deleteTodo = useCallback((id) => {
        setTodos(prev => prev.filter(t => t.id !== id));
      }, [setTodos]);

      const editTodo = useCallback((id, newText) => {
        setTodos(prev => prev.map(t => 
          t.id === id ? { ...t, text: newText } : t
        ));
      }, [setTodos]);

      // useMemo
      const filtered = useMemo(() => {
        if (filter === 'active') return todos.filter(t => !t.done);
        if (filter === 'done') return todos.filter(t => t.done);
        return todos;
      }, [todos, filter]);

      return (
        <TodoContext.Provider value={{ setTodos }}>
          <div className="app">
            <header>
              <h2>TODO List</h2>
            </header>
            
            <TodoForm />
            
            <div className="filters">
              <button 
                onClick={() => setFilter('all')} 
                style={{ background: filter === 'all' ? 'blue' : undefined }}
              >
                All
              </button>
              <button 
                onClick={() => setFilter('active')} 
                style={{ background: filter === 'active' ? 'blue' : undefined }}
              >
                Unfinished
              </button>
              <button 
                onClick={() => setFilter('done')} 
                style={{ background: filter === 'done' ? 'blue' : undefined }}
              >
                Done
              </button>
            </div>

            <div className="todo-list">
              {filtered.length === 0 ? (
                <div className="empty">No tasks</div>
              ) : (
                filtered.map(item => (
                  <TodoItem 
                    key={item.id} 
                    item={item} 
                    onToggle={toggleDone} 
                    onDelete={deleteTodo} 
                    onEdit={editTodo} 
                  />
                ))
              )}
            </div>
          </div>
        </TodoContext.Provider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TodoApp />);
  </script>
</body>
</html>